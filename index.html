<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ì–´ ë§ì”€ ë¬µìƒ í”Œë ˆì´ì–´</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f8;
      color: #222;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 1.4rem;
    }
    .hint {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 12px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    select, input[type="text"], button, textarea {
      font: inherit;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: white;
    }
    button {
      cursor: pointer;
      border: 1px solid #bbb;
    }
    button:hover {
      background: #eee;
    }
    button.primary {
      background: #2f7cf6;
      color: white;
      border-color: #2f7cf6;
    }
    button.primary:hover {
      background: #225ec0;
    }
    .search-box {
      margin: 8px 0 12px;
      display: flex;
      gap: 8px;
    }
    .search-box input {
      flex: 1;
    }
    .now-playing {
      margin: 6px 0 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #fff;
      border-left: 4px solid #2f7cf6;
      font-size: 0.9rem;
    }
    .now-playing-title {
      font-weight: 600;
    }
    .rate-display {
      font-size: 0.8rem;
      color: #555;
      margin-left: auto;
    }
    .list {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    thead {
      background: #f0f0f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th:nth-child(1), td:nth-child(1) {
      width: 32px;
      text-align: center;
    }
    th:nth-child(4), td:nth-child(4) {
      width: 70px;
      text-align: center;
    }
    tr.active {
      background: #e8f1ff;
    }
    tr:hover {
      background: #f7f7fc;
    }
    .mode-label {
      font-size: 0.85rem;
    }

    /* íŒì—… ê³µí†µ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .overlay.visible {
      display: flex;
    }
    .popup {
      max-width: 640px;
      width: 100%;
      background: #ffffff;
      border-radius: 16px;
      padding: 18px 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.25);
    }
    .popup-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: #666;
      margin-bottom: 6px;
    }
    .popup-body {
      font-size: 1.05rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .popup-hint {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #888;
      text-align: right;
    }

    /* ë…¹ìŒ ì˜ì—­ */
    .record-section {
      margin-top: 18px;
      padding: 12px 10px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #ddd;
    }
    .record-section h2 {
      font-size: 1rem;
      margin: 0 0 4px;
    }
    .record-section p {
      font-size: 0.85rem;
      color: #555;
      margin: 0 0 8px;
    }
    .record-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .record-status {
      font-size: 0.85rem;
      color: #555;
    }

    /* ìŒì„± ë©”ëª¨ ì˜ì—­ */
    .memo-section {
      margin-top: 12px;
      padding: 12px 10px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #ddd;
    }
    .memo-section h2 {
      font-size: 1rem;
      margin: 0 0 4px;
    }
    .memo-section p {
      font-size: 0.85rem;
      color: #555;
      margin: 0 0 6px;
    }
    #voiceMemo {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }
    #memoStatus {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }
    .listening {
      border-color: #2f7cf6 !important;
      box-shadow: 0 0 0 1px rgba(47, 124, 246, 0.4);
    }

    @media (max-width: 600px) {
      th:nth-child(3), td:nth-child(3) {
        display: none; /* ëª¨ë°”ì¼ì—ì„œ í•œêµ­ì–´ ì˜ë¯¸ ì»¬ëŸ¼ ìˆ¨ê¸°ê¸° (íŒì—…ìœ¼ë¡œ ë³´ê¸°) */
      }
      .controls {
        gap: 6px;
      }
    }

    /* ì „ì²´í™”ë©´ ì „ìš©: í° í™”ë©´ + ê¸°ì¡´ UI ìˆ¨ê¸°ê¸° */
    body.fs-blank {
      background: #ffffff;
    }
    body.fs-blank .app {
      display: none;
    }
    body.fs-blank .overlay {
      background: #ffffff;
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <h1>ì˜ì–´ ë§ì”€ ë¬µìƒ í”Œë ˆì´ì–´</h1>
    <div class="hint">
      ğŸ§ ì¬ìƒëª¨ë“œ: 1=ì¼ë°˜ / 2=í•œ ê³¡ ë°˜ë³µ / 3=ì¬ìƒ í›„ ë‹¤ìŒ ê³¡(ìë™ì´ë™ë§Œ) / 4=ì—°ì† ìë™ì¬ìƒ<br>
      âŒ¨ í‚¤ë³´ë“œ: <b>S</b>=ë¬¸ì¥ íŒì—…, <b>M</b>=ì˜ë¯¸ íŒì—…, <b>â†/â†’</b>=ì´ì „/ë‹¤ìŒ, <b>Enter</b>=ì¬ìƒ/ì¼ì‹œì •ì§€, <b>F</b>=ì „ì²´í™”ë©´ (í° í™”ë©´ + S/M íŒì—…)<br>
      âŒ¨ <b>R</b> = ì „ì²´ ëœë¤ ì…”í”Œ<br>
      âŒ¨ <b>E</b> = ëˆ„ë¥´ê³  ìˆëŠ” ë™ì•ˆ ìŒì„± ë©”ëª¨ ì…ë ¥ (Speech-to-Text)<br>
      âŒ¨ <b>P</b>=ë…¹ìŒ ì‹œì‘/ì •ì§€, <b>L</b>=ë…¹ìŒ ë“£ê¸°<br>
      âŒ¨ ìˆ«ì <b>0~9</b> = 0%Â·10%Â·...Â·90% ìœ„ì¹˜ë¡œ ì í”„ í›„ ì¬ìƒ<br>
      âŒ¨ <b>â†‘/â†“</b> = ì¬ìƒì†ë„ 10%ì”© ì¡°ì ˆ (ì „ì²´ ë¬¸ì¥ì— ê³µí†µì ìš©)
    </div>

    <div class="controls">
      <label class="mode-label">
        ì¬ìƒ ëª¨ë“œ:
        <select id="modeSelect">
          <option value="1">1. ì¼ë°˜ ì¬ìƒ (ëë‚˜ë©´ ë©ˆì¶¤)</option>
          <option value="2">2. ë°˜ë³µ ì¬ìƒ (í˜„ì¬ ê³¡ ë°˜ë³µ)</option>
          <option value="3">3. ì¬ìƒ í›„ ë‹¤ìŒ ê³¡ìœ¼ë¡œ (ìë™ ì´ë™ë§Œ)</option>
          <option value="4">4. ìë™ ì—°ì†ì¬ìƒ (í”Œë ˆì´ë¦¬ìŠ¤íŠ¸)</option>
        </select>
      </label>

      <button id="prevBtn">â® ì´ì „</button>
      <button id="playPauseBtn" class="primary">â–¶ ì¬ìƒ</button>
      <button id="nextBtn">â­ ë‹¤ìŒ</button>

      <button id="shuffleBtn">ğŸ”€ ì „ì²´ ëœë¤</button>
      <button id="resetOrderBtn">â†º ìˆœì°¨ ì¬ìƒ(ì´ˆê¸°í™”)</button>
      <button id="fsBtn">â›¶ ì „ì²´í™”ë©´</button>

      <span id="rateDisplay" class="rate-display">ì¬ìƒì†ë„: 100%</span>
    </div>

    <div class="search-box">
      <input id="searchInput" type="text" placeholder="ì˜ì–´ ë˜ëŠ” í•œê¸€ë¡œ ê²€ìƒ‰..." />
      <button id="clearSearchBtn">ì§€ìš°ê¸°</button>
    </div>

    <div class="now-playing" id="nowPlaying">
      <div><span class="now-playing-label">í˜„ì¬ ì„ íƒ:</span></div>
      <div class="now-playing-title" id="npTitle">ì•„ì§ ì„ íƒëœ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="npSubtitle" style="font-size:0.8rem;color:#666;"></div>
    </div>

    <div class="list">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>ì˜ì–´ ë¬¸ì¥</th>
            <th>ëœ»(ìš”ì•½)</th>
            <th>ì¬ìƒ</th>
          </tr>
        </thead>
        <tbody id="trackTbody">
          <!-- JSì—ì„œ ì±„ì›€ -->
        </tbody>
      </table>
    </div>

    <!-- ë°œìŒ í…ŒìŠ¤íŠ¸ìš© ë…¹ìŒ ì˜ì—­ -->
    <div class="record-section">
      <h2>ë°œìŒ ì—°ìŠµ (ìŒì„± ë…¹ìŒ)</h2>
      <p>ë§ˆì´í¬ë¡œ ìì‹ ì˜ ë°œìŒì„ ë…¹ìŒí•´ ë³´ê³  ë‹¤ì‹œ ë“¤ì–´ë³´ë©´ì„œ ì—°ìŠµí•´ ë³´ì„¸ìš”.</p>
      <div class="record-controls">
        <button id="recordBtn">ğŸ™ ë…¹ìŒ ì‹œì‘</button>
        <button id="playRecordBtn" disabled>â–¶ ë…¹ìŒ ë“£ê¸°</button>
        <span id="recordStatus" class="record-status">ëŒ€ê¸° ì¤‘</span>
      </div>
      <audio id="recordedAudio" controls style="width:100%;margin-top:8px;display:none;"></audio>
    </div>

    <!-- ìŒì„± ë©”ëª¨ ì˜ì—­ (Speech-to-Text) -->
    <div class="memo-section">
      <h2>ë©”ëª¨ (ìŒì„± ì…ë ¥)</h2>
      <p>E í‚¤ë¥¼ ëˆ„ë¥´ê³  ìˆëŠ” ë™ì•ˆ ë§í•˜ë©´, ì•„ë˜ ë©”ëª¨ ì¹¸ì— ìë™ìœ¼ë¡œ ê¸€ìê°€ ì…ë ¥ë©ë‹ˆë‹¤.</p>
      <textarea id="voiceMemo" placeholder="ë§ì”€ ë¬µìƒ ë©”ëª¨ë¥¼ ì—¬ê¸°ì— ì ê±°ë‚˜, E í‚¤ë¥¼ ëˆ„ë¥´ê³  ë§í•´ë³´ì„¸ìš”."></textarea>
      <div id="memoStatus">ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘ (ë¸Œë¼ìš°ì €ì—ì„œ ìŒì„± ì¸ì‹ì„ ì§€ì›í•´ì•¼ í•©ë‹ˆë‹¤)</div>
    </div>
  </div>

  <!-- ë¬¸ì¥ íŒì—… -->
  <div class="overlay" id="sentenceOverlay">
    <div class="popup">
      <div class="popup-title">ì˜ì–´ ë¬¸ì¥</div>
      <div class="popup-body" id="sentenceBody"></div>
      <div class="popup-hint">íƒ­(í´ë¦­)í•˜ë©´ ë‹«í™ë‹ˆë‹¤</div>
    </div>
  </div>

  <!-- ì˜ë¯¸ íŒì—… -->
  <div class="overlay" id="meaningOverlay">
    <div class="popup">
      <div class="popup-title">ì˜ë¯¸ (í•œêµ­ì–´)</div>
      <div class="popup-body" id="meaningBody"></div>
      <div class="popup-hint">íƒ­(í´ë¦­)í•˜ë©´ ë‹«í™ë‹ˆë‹¤</div>
    </div>
  </div>

  <script>
    // === ë°ì´í„° ì •ì˜ ===
    const tracks = [
      {id: 1, text: "Role of the Holy Spirit", meaning: "ì„±ë ¹ì˜ ì—­í• ", src: "https://github.com/cocodeKang/mp3/blob/main/Role%2Bof%2Bthe%2BHoly%2BSpirit_.mp3?raw=1"},
      {id: 2, text: "The Holy Spirit plays a crucial role in guiding believers through the process of self-reflection.", meaning: "ì„±ë ¹ì€ ì‹ ìê°€ ìê¸° ìì‹ ì„ ëŒì•„ë³´ê³  ì ê²€í•˜ë„ë¡ ì¸ë„í•˜ëŠ” ë§¤ìš° ì¤‘ìš”í•œ ì—­í• ì„ í•˜ì‹ ë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/main/The%2BHoly%2BSpirit%2Bplays%2Ba%2Bcrucial%2Brole%2Bin%2Bguiding%2Bbe.mp3?raw=1"},
      {id: 3, text: "John 16:13 states, \"But when He, the Spirit of truth, comes, He will guide you into all truth.\" .", meaning: "ìš”í•œë³µìŒ 16:13 â€” ì§„ë¦¬ì˜ ì˜ì´ì‹  ì„±ë ¹ê»˜ì„œ ì˜¤ì‹œë©´ ì‹ ìë“¤ì„ ëª¨ë“  ì§„ë¦¬ ê°€ìš´ë°ë¡œ ì¸ë„í•˜ì‹ ë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/main/John%2B16_13%2Bstates%252C%2B_But%2Bwhen%2BHe%252C%2Bthe%2BSpirit%2Bof%2Btru.mp3?raw=1"},
      {id: 4, text: "The Spirit convicts, teaches, and reveals areas in need of growth, helping believers to conform to the image of Christ.", meaning: "ì„±ë ¹ì€ ì£„ë¥¼ ê¹¨ë‹«ê²Œ í•˜ì‹œê³ , ê°€ë¥´ì¹˜ì‹œë©°, ì„±ì¥í•´ì•¼ í•  ë¶€ë¶„ì„ ë³´ì—¬ ì£¼ì…”ì„œ ì‹ ìë“¤ì´ ê·¸ë¦¬ìŠ¤ë„ì˜ ëª¨ìŠµìœ¼ë¡œ ë³€í™”ë˜ë„ë¡ ë•ëŠ”ë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/main/The%2BSpirit%2Bconvicts%252C%2Bteaches%252C%2Band%2Breveals%2Bareas%2Bin.mp3?raw=1"},
      {id: 5, text: "I have been crucified with Christ and I no longer live, but Christ lives in me.", meaning: "ë‚˜ëŠ” ê·¸ë¦¬ìŠ¤ë„ì™€ í•¨ê»˜ ì‹­ìê°€ì— ëª» ë°•í˜”ìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë¯€ë¡œ ì´ì œëŠ” ë” ì´ìƒ ë‚´ê°€ ì‚¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ë‚´ ì•ˆì— ê³„ì‹œëŠ” ê·¸ë¦¬ìŠ¤ë„ê»˜ì„œ ì‚¬ì‹œëŠ” ê²ƒì…ë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/main/I%2Bhave%2Bbeen%2Bcrucified%2Bwith%2BChrist%2Band%2BI%2Bno%2Blonger%2B.mp3?raw=1"},
      {id: 6, text: "The life I now live in the body, I live by faith in the Son of God, who loved me and gave himself for me.", meaning: "ë‚´ê°€ ì§€ê¸ˆ ìœ¡ì‹ ì„ ê°–ê³  ì‚´ê³  ìˆëŠ” ê²ƒì€, ì˜¤ì§ ë‚˜ë¥¼ ì‚¬ë‘í•˜ì…”ì„œ ë‚˜ë¥¼ ìœ„í•´ ìê¸° ëª¸ì„ ë‚´ì–´ì£¼ì‹  í•˜ë‚˜ë‹˜ì˜ ì•„ë“¤ ê·¸ë¦¬ìŠ¤ë„ë¥¼ ë¯¿ëŠ” ë¯¿ìŒìœ¼ë¡œ ì‚´ê³  ìˆëŠ” ê²ƒì…ë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/main/The%2Blife%2BI%2Bnow%2Blive%2Bin%2Bthe%2Bbody%252C%2BI%2Blive%2Bby%2Bfaith%2Bi.mp3?raw=1"},
      {id: 7, text: "You are the precious treasure hidden in the Lord, Nothing in this world can ever compare.", meaning: "ì£¼ ì•ˆì— ê°ì¶”ì¸ ë³´ë°°, ì„¸ìƒ ê²ƒê³¼ ë‚œ ë¹„ê¸¸ ìˆ˜ ì—†ë„¤", src: "https://github.com/cocodeKang/mp3/blob/main/You%2Bare%2Bthe%2Bprecious%2Btreasure%2Bhidden%2Bin%2Bthe%2BLord%252C%2B.mp3?raw=1"},
      {id: 8, text: "of your former ignorance", meaning: "ë„ˆí¬ê°€ ì´ì „ì— ê°€ì¡Œë˜ ë¬´ì§€ ê°€ìš´ë° ìˆë˜ ë•Œ", src: "https://github.com/cocodeKang/mp3/blob/412e6eca3a62dfc52973aef252348d17c7a40543/of%2Byour%2Bformer%2Bignorance.mp3?raw=1"},
      {id: 9, text: "This phrase points to the time before the recipients of the letter came to faith in Christ.", meaning: "ì´ í‘œí˜„ì€ í¸ì§€ë¥¼ ë°›ì€ ì‚¬ëŒë“¤ì´ ê·¸ë¦¬ìŠ¤ë„ë¥¼ ë¯¿ê¸° ì „ì˜ ì‹œê°„ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/412e6eca3a62dfc52973aef252348d17c7a40543/This%2Bphrase%2Bpoints%2Bto%2Bthe%2Btime%2Bbefore%2Bthe%2Brecipien.mp3?raw=1"},
      {id: 10, text: "\"Ignorance\" here refers to a lack of knowledge about God and His ways, which often led to living in sin.", meaning: "ì—¬ê¸°ì„œ â€œë¬´ì§€â€ë€ í•˜ë‚˜ë‹˜ê³¼ í•˜ë‚˜ë‹˜ì˜ ë°©ë²•ì„ ì•Œì§€ ëª»í•˜ëŠ” ìƒíƒœë¥¼ ì˜ë¯¸í•˜ë©°, ê·¸ë¡œ ì¸í•´ ì£„ ê°€ìš´ë° ì‚´ê²Œ ë˜ëŠ” ê²ƒì„ ë§í•©ë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/412e6eca3a62dfc52973aef252348d17c7a40543/%60%60Ignorance%60%60%2Bhere%2Brefers%2Bto%2Ba%2Black%2Bof%2Bknowledge%2Ba.mp3?raw=1"},
      {id: 11, text: "In Acts 17:30, Paul speaks of God overlooking the times of ignorance but now commanding all people to repent.", meaning: "ì‚¬ë„í–‰ì „ 17ì¥ 30ì ˆì—ì„œ ë°”ìš¸ì€ í•˜ë‚˜ë‹˜ê»˜ì„œ ë¬´ì§€í–ˆë˜ ì‹œëŒ€ë¥¼ ê°„ê³¼í•˜ì…¨ì§€ë§Œ ì´ì œëŠ” ëª¨ë“  ì‚¬ëŒì—ê²Œ íšŒê°œë¥¼ ëª…í•˜ì‹ ë‹¤ê³  ë§í•©ë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/412e6eca3a62dfc52973aef252348d17c7a40543/In%2BActs%2B17_30%252C%2BPaul%2Bspeaks%2Bof%2BGod%2Boverlooking%2Bthe%2B.mp3?raw=1"},
      {id: 12, text: "The call to leave behind former ignorance is a call to embrace the truth of the Gospel and live in the light of that knowledge.", meaning: "ì´ì „ì˜ ë¬´ì§€ë¥¼ ë²„ë¦¬ë¼ëŠ” ë¶€ë¥´ì‹¬ì€ ë³µìŒì˜ ì§„ë¦¬ë¥¼ ë°›ì•„ë“¤ì´ê³  ê·¸ ê¹¨ë‹¬ìŒ ì•ˆì—ì„œ ì‚´ì•„ê°€ë¼ëŠ” ë¶€ë¥´ì‹¬ì…ë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/412e6eca3a62dfc52973aef252348d17c7a40543/The%2Bcall%2Bto%2Bleave%2Bbehind%2Bformer%2Bignorance%2Bis%2Ba%2Bcal.mp3?raw=1"},
      {id: 13, text: "This transformation from ignorance to understanding is a key aspect of the Christian journey, as believers grow in their knowledge of God and His will.", meaning: "ë¬´ì§€ì—ì„œ ê¹¨ë‹¬ìŒìœ¼ë¡œ ë³€í™”ë˜ëŠ” ê³¼ì •ì€ ê·¸ë¦¬ìŠ¤ë„ì¸ì˜ ì‹ ì•™ ì—¬ì •ì—ì„œ ë§¤ìš° ì¤‘ìš”í•œ ë¶€ë¶„ì´ë©°, ì‹ ìëŠ” í•˜ë‚˜ë‹˜ê³¼ í•˜ë‚˜ë‹˜ì˜ ëœ»ì„ ì•Œì•„ê°€ë©° ì„±ì¥í•´ ê°‘ë‹ˆë‹¤.", src: "https://github.com/cocodeKang/mp3/blob/412e6eca3a62dfc52973aef252348d17c7a40543/This%2Btransformation%2Bfrom%2Bignorance%2Bto%2Bunderstandin.mp3?raw=1"}
    ];

    // ì¬ìƒ ìˆœì„œ ê´€ë¦¬ìš©
    let order = tracks.map((_, i) => i);
    let currentPos = 0; // order ë°°ì—´ ì•ˆì—ì„œì˜ ìœ„ì¹˜
    let currentMode = 1; // 1~4
    const audio = new Audio();
    let isPlaying = false;

    // ì¬ìƒì†ë„ ê´€ë¦¬ (ì „ì²´ ë¬¸ì¥ì— ê³µí†µ)
    let playbackRate = 1.0;
    const MIN_RATE = 0.5;
    const MAX_RATE = 2.0;
    let pendingSeekPercent = null;

    // DOM
    const appRoot = document.getElementById("appRoot");
    const modeSelect = document.getElementById("modeSelect");
    const prevBtn = document.getElementById("prevBtn");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const nextBtn = document.getElementById("nextBtn");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const resetOrderBtn = document.getElementById("resetOrderBtn");
    const fsBtn = document.getElementById("fsBtn");
    const rateDisplay = document.getElementById("rateDisplay");
    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const trackTbody = document.getElementById("trackTbody");
    const npTitle = document.getElementById("npTitle");
    const npSubtitle = document.getElementById("npSubtitle");
    const sentenceOverlay = document.getElementById("sentenceOverlay");
    const meaningOverlay = document.getElementById("meaningOverlay");
    const sentenceBody = document.getElementById("sentenceBody");
    const meaningBody = document.getElementById("meaningBody");

    // ë…¹ìŒ ê´€ë ¨ DOM
    const recordBtn = document.getElementById("recordBtn");
    const playRecordBtn = document.getElementById("playRecordBtn");
    const recordStatus = document.getElementById("recordStatus");
    const recordedAudio = document.getElementById("recordedAudio");

    // ìŒì„± ë©”ëª¨ ê´€ë ¨ DOM
    const voiceMemo = document.getElementById("voiceMemo");
    const memoStatus = document.getElementById("memoStatus");

    // ë…¹ìŒ ìƒíƒœ
    let mediaRecorder = null;
    let recordedChunks = [];
    let isRecording = false;

    // ìŒì„± ì¸ì‹ ìƒíƒœ
    let recognition = null;
    let isSpeechSupported = false;
    let isListening = false;
    let voiceKeyPressed = false; // E í‚¤ ëˆ„ë¥´ê³  ìˆëŠ”ì§€

    // === ìœ í‹¸ ===
    function getCurrentTrackIndex() {
      return order[currentPos] ?? 0;
    }
    function getCurrentTrack() {
      return tracks[getCurrentTrackIndex()];
    }

    function applyPlaybackRate() {
      audio.playbackRate = playbackRate;
      rateDisplay.textContent = "ì¬ìƒì†ë„: " + Math.round(playbackRate * 100) + "%";
    }

    function renderList() {
      const q = searchInput.value.trim().toLowerCase();
      trackTbody.innerHTML = "";
      order.forEach((trackIdx, pos) => {
        const t = tracks[trackIdx];
        const en = t.text.toLowerCase();
        const ko = t.meaning.toLowerCase();

        if (q && !en.includes(q) && !ko.includes(q)) {
          return; // ê²€ìƒ‰ì— ì•ˆ ê±¸ë¦¬ë©´ ìˆ¨ê¹€
        }

        const tr = document.createElement("tr");
        if (pos === currentPos) {
          tr.classList.add("active");
        }
        tr.dataset.pos = String(pos);

        const tdNum = document.createElement("td");
        tdNum.textContent = String(pos + 1);

        const tdEn = document.createElement("td");
        tdEn.textContent = t.text;

        const tdKo = document.createElement("td");
        tdKo.textContent = t.meaning;

        const tdPlay = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "â–¶";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          selectTrack(pos);
          playCurrent();
        });
        tdPlay.appendChild(btn);

        tr.appendChild(tdNum);
        tr.appendChild(tdEn);
        tr.appendChild(tdKo);
        tr.appendChild(tdPlay);

        tr.addEventListener("click", () => {
          selectTrack(pos);
        });

        trackTbody.appendChild(tr);
      });
      updateNowPlaying();
    }

    function selectTrack(pos) {
      currentPos = pos;
      loadCurrentTrack();
      highlightActiveRow();
      updateNowPlaying();
    }

    function highlightActiveRow() {
      [...trackTbody.querySelectorAll("tr")].forEach((tr) => {
        const p = Number(tr.dataset.pos);
        tr.classList.toggle("active", p === currentPos);
      });
    }

    function loadCurrentTrack() {
      const t = getCurrentTrack();
      if (!t) return;
      audio.src = t.src;
      applyPlaybackRate();
    }

    function updateNowPlaying() {
      const t = getCurrentTrack();
      if (!t) {
        npTitle.textContent = "ì•„ì§ ì„ íƒëœ íŠ¸ë™ì´ ì—†ìŠµë‹ˆë‹¤.";
        npSubtitle.textContent = "";
        return;
      }
      npTitle.textContent = t.text;
      npSubtitle.textContent = t.meaning;
    }

    async function playCurrent() {
      const t = getCurrentTrack();
      if (!t) return;
      if (!audio.src) loadCurrentTrack();
      try {
        applyPlaybackRate();
        await audio.play();
        isPlaying = true;
        playPauseBtn.textContent = "â¸ ì¼ì‹œì •ì§€";
        playPauseBtn.classList.add("primary");
        highlightActiveRow();
      } catch (err) {
        console.error("ì¬ìƒ ì˜¤ë¥˜:", err);
      }
    }

    function pauseCurrent() {
      audio.pause();
      isPlaying = false;
      playPauseBtn.textContent = "â–¶ ì¬ìƒ";
      playPauseBtn.classList.add("primary");
    }

    function nextTrack(autoPlay = false) {
      if (order.length === 0) return;
      currentPos = (currentPos + 1) % order.length;
      loadCurrentTrack();
      highlightActiveRow();
      updateNowPlaying();
      if (autoPlay) {
        playCurrent();
      } else {
        pauseCurrent();
      }
    }

    function prevTrack(autoPlay = false) {
      if (order.length === 0) return;
      currentPos = (currentPos - 1 + order.length) % order.length;
      loadCurrentTrack();
      highlightActiveRow();
      updateNowPlaying();
      if (autoPlay) {
        playCurrent();
      } else {
        pauseCurrent();
      }
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function shuffleOrder() {
      order = shuffleArray(tracks.map((_, i) => i));
      currentPos = 0;
      loadCurrentTrack();
      renderList();
    }

    function resetOrder() {
      order = tracks.map((_, i) => i);
      currentPos = 0;
      loadCurrentTrack();
      renderList();
    }

    function showSentencePopup() {
      const t = getCurrentTrack();
      if (!t) return;
      sentenceBody.textContent = t.text;
      sentenceOverlay.classList.add("visible");
    }

    function showMeaningPopup() {
      const t = getCurrentTrack();
      if (!t) return;
      meaningBody.textContent = t.meaning;
      meaningOverlay.classList.add("visible");
    }

    function hideSentencePopup() {
      sentenceOverlay.classList.remove("visible");
    }
    function hideMeaningPopup() {
      meaningOverlay.classList.remove("visible");
    }

    // === ì „ì²´í™”ë©´ ===
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        appRoot.requestFullscreen?.().catch(err => {
          console.error("ì „ì²´í™”ë©´ ìš”ì²­ ì‹¤íŒ¨:", err);
        });
      } else {
        document.exitFullscreen?.();
      }
    }

    document.addEventListener("fullscreenchange", () => {
      const isFs = !!document.fullscreenElement;
      document.body.classList.toggle("fs-blank", isFs);
      fsBtn.textContent = isFs ? "âœ• ì „ì²´í™”ë©´ í•´ì œ" : "â›¶ ì „ì²´í™”ë©´";
    });

    // === ë…¹ìŒ ê¸°ëŠ¥ (ë°œìŒ í…ŒìŠ¤íŠ¸) ===
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: "audio/webm" });
          const url = URL.createObjectURL(blob);
          recordedAudio.src = url;
          recordedAudio.style.display = "block";
          playRecordBtn.disabled = false;
          recordStatus.textContent = "ë…¹ìŒ ì™„ë£Œ (L í‚¤ ë˜ëŠ” ë²„íŠ¼ìœ¼ë¡œ ë‹¤ì‹œ ë“¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)";
        };

        mediaRecorder.start();
        isRecording = true;
        recordBtn.textContent = "â–  ë…¹ìŒ ì •ì§€";
        recordStatus.textContent = "ë…¹ìŒ ì¤‘...";
      } catch (err) {
        console.error("ë…¹ìŒ ì—ëŸ¬:", err);
        recordStatus.textContent = "ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”.";
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach((t) => t.stop());
        isRecording = false;
        recordBtn.textContent = "ğŸ™ ë…¹ìŒ ì‹œì‘";
      }
    }

    // === ìŒì„± ì¸ì‹ (E í‚¤ ëˆ„ë¥´ê³  ìˆì„ ë•Œ) ===
    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        memoStatus.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)";
        isSpeechSupported = false;
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "ko-KR";    // ë©”ëª¨ëŠ” ê¸°ë³¸ í•œêµ­ì–´
      recognition.interimResults = true;
      recognition.continuous = false;

      recognition.onstart = () => {
        isListening = true;
        memoStatus.textContent = "ìŒì„± ì¸ì‹ ì¤‘... (E í‚¤ë¥¼ ë–¼ë©´ ì¢…ë£Œë©ë‹ˆë‹¤)";
        voiceMemo.classList.add("listening");
      };

      recognition.onend = () => {
        isListening = false;
        voiceMemo.classList.remove("listening");
        if (!voiceKeyPressed) {
          memoStatus.textContent = "ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘ (E í‚¤ë¥¼ ëˆ„ë¥´ê³  ë§í•´ë³´ì„¸ìš”)";
        }
      };

      recognition.onerror = (e) => {
        console.error("Speech recognition error:", e);
        memoStatus.textContent = "ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      };

      recognition.onresult = (event) => {
        let finalTranscript = "";
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const result = event.results[i];
          if (result.isFinal) {
            finalTranscript += result[0].transcript + " ";
          }
        }
        if (finalTranscript) {
          const current = voiceMemo.value.trim();
          voiceMemo.value = current
            ? current + " " + finalTranscript.trim()
            : finalTranscript.trim();
        }
      };

      isSpeechSupported = true;
      memoStatus.textContent = "ìŒì„± ì¸ì‹ ëŒ€ê¸° ì¤‘ (E í‚¤ë¥¼ ëˆ„ë¥´ê³  ë§í•´ë³´ì„¸ìš”)";
    }

    function startVoiceInput() {
      if (!isSpeechSupported || !recognition) return;
      try {
        recognition.start();
      } catch (e) {
        console.warn("Recognition start ì˜¤ë¥˜ ë˜ëŠ” ì¤‘ë³µ ì‹¤í–‰:", e);
      }
    }

    function stopVoiceInput() {
      if (!isSpeechSupported || !recognition) return;
      try {
        recognition.stop();
      } catch (e) {
        console.warn("Recognition stop ì˜¤ë¥˜:", e);
      }
    }

    // === ì¬ìƒ ìœ„ì¹˜ ì í”„ (ìˆ«ì 0~9) ===
    function seekToPercent(percent) {
      if (!audio.src) {
        loadCurrentTrack();
      }
      if (isFinite(audio.duration) && audio.duration > 0) {
        audio.currentTime = audio.duration * percent;
        if (!isPlaying) {
          playCurrent();
        }
        pendingSeekPercent = null;
      } else {
        pendingSeekPercent = percent;
        if (!isPlaying) {
          playCurrent();
        } else {
          audio.play().catch(() => {});
        }
      }
    }

    audio.addEventListener("loadedmetadata", () => {
      if (pendingSeekPercent !== null && isFinite(audio.duration) && audio.duration > 0) {
        audio.currentTime = audio.duration * pendingSeekPercent;
        pendingSeekPercent = null;
      }
    });

    // === ì¬ìƒì†ë„ ì¡°ì ˆ (â†‘ / â†“) ===
    function adjustPlaybackRate(delta) {
      playbackRate = Math.min(MAX_RATE, Math.max(MIN_RATE, playbackRate + delta));
      applyPlaybackRate();
    }

    // === ì´ë²¤íŠ¸ ë°”ì¸ë”© ===
    modeSelect.addEventListener("change", () => {
      currentMode = Number(modeSelect.value);
    });

    playPauseBtn.addEventListener("click", () => {
      if (!isPlaying) {
        if (!audio.src) loadCurrentTrack();
        playCurrent();
      } else {
        pauseCurrent();
      }
    });

    prevBtn.addEventListener("click", () => prevTrack(isPlaying));
    nextBtn.addEventListener("click", () => nextTrack(isPlaying));

    shuffleBtn.addEventListener("click", () => {
      shuffleOrder();
    });

    resetOrderBtn.addEventListener("click", () => {
      resetOrder();
    });

    fsBtn.addEventListener("click", () => {
      toggleFullscreen();
    });

    searchInput.addEventListener("input", () => {
      renderList();
    });

    clearSearchBtn.addEventListener("click", () => {
      searchInput.value = "";
      renderList();
      searchInput.focus();
    });

    // ì˜¤ë””ì˜¤ ëë‚¬ì„ ë•Œ ëª¨ë“œë³„ ì²˜ë¦¬
    audio.addEventListener("ended", () => {
      switch (currentMode) {
        case 1: // ì¼ë°˜ ì¬ìƒ
          pauseCurrent();
          break;
        case 2: // ë°˜ë³µ ì¬ìƒ
          audio.currentTime = 0;
          playCurrent();
          break;
        case 3: // ë‹¤ìŒ ê³¡ìœ¼ë¡œ ì´ë™ë§Œ (ìë™ì¬ìƒ X)
          nextTrack(false);
          break;
        case 4: // ë‹¤ìŒ ê³¡ ìë™ì¬ìƒ
          nextTrack(true);
          break;
      }
    });

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (ì…ë ¥ì°½/í…ìŠ¤íŠ¸ì˜ì—­ì—ì„œëŠ” ë™ì‘ X)
    document.addEventListener("keydown", (e) => {
      const tag = e.target.tagName;
      if (tag === "INPUT" || tag === "TEXTAREA") {
        return;
      }

      const key = e.key;

      // E í‚¤: ìŒì„± ë©”ëª¨ ì…ë ¥ (ëˆ„ë¥´ê³  ìˆëŠ” ë™ì•ˆ)
      if (key === "e" || key === "E") {
        if (!voiceKeyPressed) {
          voiceKeyPressed = true;
          e.preventDefault();
          if (isSpeechSupported) {
            startVoiceInput();
          }
        }
        return;
      }

      // ìˆ«ì 0~9: í¼ì„¼íŠ¸ ìœ„ì¹˜ ì í”„
      if (key >= "0" && key <= "9") {
        const num = Number(key);
        const percent = num === 0 ? 0 : num / 10; // 0=0%, 1=10%, ..., 9=90%
        seekToPercent(percent);
        return;
      }

      // Enter: ì¬ìƒ/ì¼ì‹œì •ì§€
      if (key === "Enter") {
        e.preventDefault();
        if (!isPlaying) {
          if (!audio.src) loadCurrentTrack();
          playCurrent();
        } else {
          pauseCurrent();
        }
        return;
      }

      const lower = key.toLowerCase();

      if (lower === "s") {
        // ë¬¸ì¥ íŒì—… í† ê¸€
        if (sentenceOverlay.classList.contains("visible")) {
          hideSentencePopup();
        } else {
          showSentencePopup();
        }
      } else if (lower === "m") {
        // ì˜ë¯¸ íŒì—… í† ê¸€
        if (meaningOverlay.classList.contains("visible")) {
          hideMeaningPopup();
        } else {
          showMeaningPopup();
        }
      } else if (lower === "f") {
        // ì „ì²´í™”ë©´ í† ê¸€
        e.preventDefault();
        toggleFullscreen();
      } else if (lower === "r") {
        // ì „ì²´ ëœë¤ ì…”í”Œ
        shuffleOrder();
      } else if (key === "ArrowRight") {
        // ë‹¤ìŒ ë¬¸ì¥
        nextTrack(isPlaying);
      } else if (key === "ArrowLeft") {
        // ì´ì „ ë¬¸ì¥
        prevTrack(isPlaying);
      } else if (key === "ArrowUp") {
        e.preventDefault();
        adjustPlaybackRate(0.1); // +10%
      } else if (key === "ArrowDown") {
        e.preventDefault();
        adjustPlaybackRate(-0.1); // -10%
      } else if (lower === "p") {
        // ë…¹ìŒ ì‹œì‘/ì •ì§€
        if (!isRecording) {
          startRecording();
        } else {
          stopRecording();
        }
      } else if (lower === "l") {
        // ë…¹ìŒ ë“£ê¸°
        if (recordedAudio.src) {
          recordedAudio.play().catch(err => console.error(err));
        }
      }
    });

    document.addEventListener("keyup", (e) => {
      const tag = e.target.tagName;
      if (tag === "INPUT" || tag === "TEXTAREA") {
        return;
      }
      if ((e.key === "e" || e.key === "E") && voiceKeyPressed) {
        voiceKeyPressed = false;
        if (isSpeechSupported) {
          stopVoiceInput();
        }
      }
    });

    // íŒì—… í„°ì¹˜/í´ë¦­ ì‹œ ë‹«ê¸°
    sentenceOverlay.addEventListener("click", hideSentencePopup);
    meaningOverlay.addEventListener("click", hideMeaningPopup);

    // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ (ìœ„/ì•„ë˜)
    let touchStartY = null;
    document.addEventListener("touchstart", (e) => {
      if (e.touches.length === 1) {
        touchStartY = e.touches[0].clientY;
      }
    }, { passive: true });

    document.addEventListener("touchend", (e) => {
      if (touchStartY === null) return;
      const endY = (e.changedTouches[0] || e.touches[0]).clientY;
      const dy = endY - touchStartY;

      const THRESHOLD = 40; // px
      if (Math.abs(dy) > THRESHOLD) {
        if (dy < 0) {
          // ìœ„ë¡œ ìŠ¤ì™€ì´í”„ => ë¬¸ì¥
          showSentencePopup();
        } else {
          // ì•„ë˜ë¡œ ìŠ¤ì™€ì´í”„ => ì˜ë¯¸
          showMeaningPopup();
        }
      }
      touchStartY = null;
    }, { passive: true });

    // ë…¹ìŒ ë²„íŠ¼
    recordBtn.addEventListener("click", () => {
      if (!isRecording) {
        startRecording();
      } else {
        stopRecording();
      }
    });

    // ë…¹ìŒ ì¬ìƒ ë²„íŠ¼
    playRecordBtn.addEventListener("click", () => {
      if (recordedAudio.src) {
        recordedAudio.play().catch(err => console.error(err));
      }
    });

    // ì´ˆê¸° ë Œë”ë§
    (function init() {
      currentMode = Number(modeSelect.value);
      loadCurrentTrack();
      renderList();
      applyPlaybackRate();
      initSpeechRecognition();
    })();
  </script>
</body>
</html>
